{
    "task": "5a547ed72c09faf4050739d54caea1d51f4d276d.txt",
    "provider": "anthropic",
    "model": "claude-haiku-4-5",
    "rounds": [
        {
            "code": "package main\n\nimport (\n\t\"fmt\"\n\t\"sync\"\n\t\"time\"\n)\n\ntype ServerManager struct {\n\tmu          sync.RWMutex\n\tservices    map[string]*service\n\tstopOnce    sync.Once\n\tstopChan    chan struct{}\n\twg          sync.WaitGroup\n\tshutdownMu  sync.Mutex\n\tisShutdown  bool\n}\n\ntype service struct {\n\tname     string\n\tstopChan chan struct{}\n\tdone     chan struct{}\n}\n\nfunc NewServerManager() *ServerManager {\n\treturn &ServerManager{\n\t\tservices: make(map[string]*service),\n\t\tstopChan: make(chan struct{}),\n\t}\n}\n\nfunc (sm *ServerManager) Start(serviceName string) error {\n\tsm.mu.Lock()\n\tdefer sm.mu.Unlock()\n\n\tif _, exists := sm.services[serviceName]; exists {\n\t\treturn fmt.Errorf(\"service %s already running\", serviceName)\n\t}\n\n\tsvc := &service{\n\t\tname:     serviceName,\n\t\tstopChan: make(chan struct{}),\n\t\tdone:     make(chan struct{}),\n\t}\n\n\tsm.services[serviceName] = svc\n\tsm.wg.Add(1)\n\n\tgo func() {\n\t\tdefer sm.wg.Done()\n\t\tdefer close(svc.done)\n\n\t\tfmt.Printf(\"[%s] Service started\\n\", serviceName)\n\n\t\tselect {\n\t\tcase <-svc.stopChan:\n\t\t\tfmt.Printf(\"[%s] Received shutdown signal\\n\", serviceName)\n\t\tcase <-sm.stopChan:\n\t\t\tfmt.Printf(\"[%s] Received manager shutdown signal\\n\", serviceName)\n\t\t}\n\n\t\tfmt.Printf(\"[%s] Performing cleanup...\\n\", serviceName)\n\t\ttime.Sleep(100 * time.Millisecond)\n\t\tfmt.Printf(\"[%s] Cleanup completed\\n\", serviceName)\n\t}()\n\n\treturn nil\n}\n\nfunc (sm *ServerManager) GracefulStop() {\n\tsm.shutdownMu.Lock()\n\tdefer sm.shutdownMu.Unlock()\n\n\tif sm.isShutdown {\n\t\tfmt.Printf(\"[GracefulStop] Already shutting down, ignoring duplicate call from goroutine\\n\")\n\t\treturn\n\t}\n\n\tsm.isShutdown = true\n\n\tfmt.Printf(\"[GracefulStop] Initiating graceful shutdown\\n\")\n\n\tsm.stopOnce.Do(func() {\n\t\tclose(sm.stopChan)\n\t})\n\n\tsm.mu.RLock()\n\tserviceNames := make([]string, 0, len(sm.services))\n\tfor name := range sm.services {\n\t\tserviceNames = append(serviceNames, name)\n\t}\n\tsm.mu.RUnlock()\n\n\tfmt.Printf(\"[GracefulStop] Stopping %d service(s)\\n\", len(serviceNames))\n\n\tfor _, name := range serviceNames {\n\t\tsm.mu.RLock()\n\t\tsvc, exists := sm.services[name]\n\t\tsm.mu.RUnlock()\n\n\t\tif exists {\n\t\t\tselect {\n\t\t\tcase <-svc.done:\n\t\t\tcase svc.stopChan <- struct{}{}:\n\t\t\t}\n\t\t}\n\t}\n\n\tsm.wg.Wait()\n\n\tfmt.Printf(\"[GracefulStop] All services stopped\\n\")\n}\n\nfunc (sm *ServerManager) IsRunning() bool {\n\tsm.mu.RLock()\n\tdefer sm.mu.RUnlock()\n\n\tfor _, svc := range sm.services {\n\t\tselect {\n\t\tcase <-svc.done:\n\t\tdefault:\n\t\t\treturn true\n\t\t}\n\t}\n\n\treturn false\n}\n\nfunc main() {\n\tfmt.Println(\"=== Starting Concurrent gRPC-like Server Shutdown Manager ===\\n\")\n\n\tmanager := NewServerManager()\n\n\tfmt.Println(\"--- Phase 1: Starting multiple services ---\")\n\terr := manager.Start(\"AuthService\")\n\tif err != nil {\n\t\tfmt.Printf(\"Error starting AuthService: %v\\n\", err)\n\t}\n\n\terr = manager.Start(\"DatabaseService\")\n\tif err != nil {\n\t\tfmt.Printf(\"Error starting DatabaseService: %v\\n\", err)\n\t}\n\n\terr = manager.Start(\"CacheService\")\n\tif err != nil {\n\t\tfmt.Printf(\"Error starting CacheService: %v\\n\", err)\n\t}\n\n\ttime.Sleep(200 * time.Millisecond)\n\n\tfmt.Printf(\"\\nIsRunning: %v\\n\", manager.IsRunning())\n\n\tfmt.Println(\"\\n--- Phase 2: Concurrent GracefulStop calls ---\")\n\tstopWg := sync.WaitGroup{}\n\n\tfor i := 1; i <= 3; i++ {\n\t\tstopWg.Add(1)\n\t\tgo func(id int) {\n\t\t\tdefer stopWg.Done()\n\t\t\tfmt.Printf(\"Goroutine %d calling GracefulStop\\n\", id)\n\t\t\tmanager.GracefulStop()\n\t\t}(i)\n\t}\n\n\tstopWg.Wait()\n\n\tfmt.Println(\"\\n--- Phase 3: Verification ---\")\n\tfmt.Printf(\"IsRunning after GracefulStop: %v\\n\", manager.IsRunning())\n\n\tfmt.Println(\"\\n--- Phase 4: Testing duplicate GracefulStop ---\")\n\tmanager.GracefulStop()\n\n\tfmt.Println(\"\\n=== All tests completed successfully ===\")\n}",
            "passed": true,
            "errors": []
        }
    ],
    "passed": true
}